Merging Advertising Data with SQL (Date & Window Functions)

## ðŸ“ Project Overview / Proje Genel BakÄ±ÅŸ
-This project focuses on merging advertising data from different sources, processing it for monthly trend analysis, and calculating performance metrics. By utilizing date functions, we extract the first day of the month, and with window functions, we compute the previous month's key performance indicators (KPIs). Finally, we calculate the percentage change in CPM, CPC, CTR, and ROMI compared to the previous month to understand campaign performance fluctuations.
Bu proje, farklÄ± kaynaklardan gelen reklam verilerini birleÅŸtirmeye, aylÄ±k eÄŸilim analizleri iÃ§in iÅŸlemeye ve performans metriklerini hesaplamaya odaklanmaktadÄ±r. Tarih fonksiyonlarÄ± kullanÄ±larak her ayÄ±n ilk gÃ¼nÃ¼ Ã§Ä±karÄ±lÄ±r ve pencere (window) fonksiyonlarÄ± ile bir Ã¶nceki aya ait temel performans gÃ¶stergeleri (KPI'lar) hesaplanÄ±r. Son olarak, CPM, CPC, CTR ve ROMI'nin bir Ã¶nceki aya gÃ¶re yÃ¼zdesel deÄŸiÅŸimi hesaplanarak kampanya performansÄ±ndaki dalgalanmalar analiz edilir.

## Objectives / Hedefler
-Combine advertising data from multiple sources into a unified dataset.
FarklÄ± kaynaklardan gelen reklam verilerini tek bir veri kÃ¼mesinde birleÅŸtirmek.
-Extract the first day of the month from the ad_date column to analyze monthly trends.
AylÄ±k eÄŸilimleri analiz etmek iÃ§in ad_date sÃ¼tunundan ayÄ±n ilk gÃ¼nÃ¼nÃ¼ Ã§Ä±karmak.
-Use window functions to retrieve previous month's metrics for each campaign.
Her kampanya iÃ§in bir Ã¶nceki aya ait metrikleri almak iÃ§in pencere (window) fonksiyonlarÄ±nÄ± kullanmak.
-Calculate the percentage change in CPM, CPC, CTR, and ROMI compared to the previous month.
CPM, CPC, CTR ve ROMI'nin bir Ã¶nceki aya gÃ¶re yÃ¼zdesel deÄŸiÅŸimini hesaplamak.
-Ensure accurate calculations by handling NULL and zero values appropriately.
NULL ve sÄ±fÄ±r deÄŸerleri uygun ÅŸekilde ele alarak hesaplamalarÄ±n doÄŸruluÄŸunu saÄŸlamak.

## SQL Query Explanation / SQL Sorgusunun AÃ§Ä±klamasÄ±
1. CTE (Common Table Expression) for Data Consolidation
Veri BirleÅŸtirme iÃ§in CTE (Common Table Expression)
  -The first CTE (cte_1) merges data from Facebook and Google Ads using UNION ALL.
  Ä°lk CTE (cte_1), UNION ALL kullanarak Facebook ve Google Ads verilerini birleÅŸtirir.
  -NULL metric values are replaced with zero using COALESCE to ensure accurate calculations.
  NULL olan metrik deÄŸerleri COALESCE fonksiyonu ile sÄ±fÄ±r olarak deÄŸiÅŸtirilerek hesaplamalarÄ±n doÄŸruluÄŸu saÄŸlanÄ±r.
2. CTE for Data Processing and KPI Calculation
Veri Ä°ÅŸleme ve KPI Hesaplama iÃ§in CTE
  -Extracts utm_campaign values from url_parameters using regular expressions.
  utm_campaign deÄŸerleri dÃ¼zenli ifadeler (regex) kullanÄ±larak url_parameters iÃ§inden Ã§Ä±karÄ±lÄ±r.
  -Converts utm_campaign values to lowercase and replaces 'nan' with NULL.
  utm_campaign deÄŸerleri kÃ¼Ã§Ã¼k harfe Ã§evrilir ve 'nan' olanlar NULL olarak deÄŸiÅŸtirilir.
  -Aggregates key metrics: total cost, impressions, clicks, and conversion value.
  Toplam maliyet, gÃ¶sterimler, tÄ±klamalar ve dÃ¶nÃ¼ÅŸÃ¼m deÄŸeri gibi temel metrikler toplanÄ±r.
  -Calculates CTR, CPC, CPM, and ROMI while handling division errors with CASE statements.
  CASE ifadeleri kullanÄ±larak sÄ±fÄ±ra bÃ¶lme hatalarÄ±ndan kaÃ§Ä±nÄ±larak CTR, CPC, CPM ve ROMI hesaplanÄ±r.
3. CTE for Monthly Aggregation and Trend Analysis
AylÄ±k Toplama ve EÄŸilim Analizi iÃ§in CTE
  -Extracts ad_month as the first day of the month from ad_date.
  ad_date sÃ¼tunundan ayÄ±n ilk gÃ¼nÃ¼ olarak ad_month deÄŸeri Ã§Ä±karÄ±lÄ±r.
  -Uses LAG() window function to retrieve previous month's CPM, CPC, CTR, and ROMI for each campaign.
  LAG() pencere fonksiyonu kullanÄ±larak her kampanya iÃ§in bir Ã¶nceki aya ait CPM, CPC, CTR ve ROMI hesaplanÄ±r.
4. Final Selection with Percentage Change Calculation
SonuÃ§ SeÃ§imi ve YÃ¼zdesel DeÄŸiÅŸim Hesaplama
  -Computes the percentage difference in CPM, CPC, CTR, and ROMI compared to the previous month.
  CPM, CPC, CTR ve ROMI'nin bir Ã¶nceki aya gÃ¶re yÃ¼zdesel deÄŸiÅŸimi hesaplanÄ±r.
  -Ensures no division by zero errors by applying conditions in CASE statements.
  CASE ifadeleri ile sÄ±fÄ±ra bÃ¶lme hatalarÄ±ndan kaÃ§Ä±nÄ±larak hesaplamalarÄ±n doÄŸruluÄŸu saÄŸlanÄ±r.

## Technologies Used / KullanÄ±lan Teknolojiler
-PostgreSQL - Data extraction, transformation, and KPI calculations.
PostgreSQL - Veri Ã§Ä±karma, dÃ¶nÃ¼ÅŸtÃ¼rme ve KPI hesaplamalarÄ±.
-CTE (Common Table Expressions) - Structuring complex queries for better readability.
CTE (Ortak Tablo Ä°fadeleri) - KarmaÅŸÄ±k sorgularÄ± daha okunabilir hale getirmek iÃ§in kullanÄ±lÄ±r.
-Window Functions (LAG()) - Retrieving previous month's values for trend analysis.
Pencere FonksiyonlarÄ± (LAG()) - EÄŸilim analizi iÃ§in bir Ã¶nceki aya ait deÄŸerleri almak.
-Date Functions (date_trunc) - Extracting the first day of the month.
Tarih FonksiyonlarÄ± (date_trunc) - AyÄ±n ilk gÃ¼nÃ¼nÃ¼ Ã§Ä±karmak iÃ§in kullanÄ±lÄ±r.
-Regular Expressions (substring()) - Extracting UTM campaign values from URL parameters.
DÃ¼zenli Ä°fadeler (substring()) - URL parametrelerinden UTM kampanya deÄŸerlerini Ã§Ä±karmak.

```sql
WITH cte_1 AS (
    SELECT
        fb_ads.ad_date AS ad_date,
        fb_ads.url_parameters AS url_parameters,
        COALESCE(fb_ads.spend,0) AS spend,
        COALESCE(fb_ads.impressions,0) AS impressions,
        COALESCE(fb_ads.reach,0) AS reach,
        fb_ads.clicks AS clicks,
        fb_ads.leads AS leads,
        fb_ads.value AS value
    FROM
        facebook_ads_basic_daily AS fb_ads
    JOIN
        facebook_adset AS fb_adset
        ON fb_ads.adset_id = fb_adset.adset_id
    JOIN
        facebook_campaign AS fb_camp
        ON fb_ads.campaign_id = fb_camp.campaign_id
    UNION ALL
    SELECT
        ga.ad_date,
        ga.url_parameters,
        COALESCE(ga.spend,0) AS spend,
        COALESCE(ga.impressions,0) AS impressions,
        COALESCE(ga.reach,0) AS reach,
        ga.clicks AS clicks,
        ga.leads AS leads,
        ga.value AS value
    FROM
        google_ads_basic_daily AS ga
),
cte_2 AS (
    SELECT
        ad_date,
        url_parameters,
        CASE
	        when lower(substring(url_parameters, 'utm_campaign=([^&#$]+)')) = 'nan' then null
            else lower(substring(url_parameters, 'utm_campaign=([^&#$]+)'))
        END AS utm_campaign,
        coalesce(sum(spend), 0) as total_cost,
        coalesce(sum(impressions), 0) as total_impressions,
        coalesce(sum(clicks), 0) as total_clicks,
        coalesce(sum(value), 0) as total_value,
        CASE
        	WHEN sum(impressions) > 0 THEN ROUND((SUM(clicks)::numeric / SUM(impressions)::numeric) * 100, 2)
        	ELSE 0
        END AS CTR,
        CASE
  			  WHEN sum(clicks) > 0 THEN round(sum(spend)::float/sum(clicks)::float)
  	          ELSE 0
        END AS CPC,
        CASE
        	WHEN sum(impressions) > 0 THEN round((sum(spend)::numeric *100)/sum(impressions)::numeric,2)
        	ELSE 0
        END AS CPM,
        CASE
        	WHEN sum(spend) > 0 THEN  round((sum(value)::numeric) / sum(spend),4) * 100
        	ELSE 0
        END AS ROMI
    FROM cte_1
    GROUP BY ad_date, url_parameters),
cte_3 AS (
	SELECT
		date(date_trunc('month', ad_date)) AS ad_month,
		utm_campaign,
		total_cost,
		total_impressions,
		total_clicks,
		total_value,
		CTR,
		CPC,
		CPM,
		ROMI,
		lag(avg(CPM)) OVER (PARTITION BY utm_campaign ORDER BY DATE_TRUNC('month', ad_date)) AS previous_month_CPM,
		lag(avg(CPC)) OVER (PARTITION BY utm_campaign ORDER BY DATE_TRUNC('month', ad_date)) AS previous_month_CPC,
		lag(avg(CTR)) OVER (PARTITION BY utm_campaign ORDER BY DATE_TRUNC('month', ad_date)) AS previous_month_CTR,
		lag(avg(ROMI)) OVER (PARTITION BY utm_campaign ORDER BY DATE_TRUNC('month', ad_date)) AS previous_month_ROMI
	FROM cte_2
	GROUP BY 1,2,3,4,5,6,7,8,9,10,ad_date)
SELECT
	ad_month,
	utm_campaign,
	total_cost,
	total_impressions,
	total_clicks,
	total_value,
	previous_month_CTR,
	previous_month_CPC,
	previous_month_CPM,
	previous_month_ROMI,
	CASE
		WHEN previous_month_CPM = 0 THEN 0
		ELSE (CPM - previous_month_CPM) * 100 / previous_month_CPM	
	END AS CPM_diff,
	CASE
		WHEN previous_month_CPC = 0 OR previous_month_CPC IS NULL THEN 0 
		ELSE (CPC - previous_month_CPC) * 100 / previous_month_CPC 	
	END AS CPC_diff,
	CASE
		WHEN previous_month_CTR = 0 THEN 0
		ELSE (CTR - previous_month_CTR) * 100 / previous_month_CTR	
	END AS CTR_diff,
	CASE
		WHEN previous_month_ROMI = 0 THEN 0
		ELSE (ROMI - previous_month_ROMI) * 100 / previous_month_ROMI	
	END AS ROMI_diff
FROM cte_3
ORDER BY ad_month;
```
